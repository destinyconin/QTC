# build
FROM ubuntu:22.04 AS builder
RUN apt-get update && apt-get install -y \
  build-essential cmake git libssl-dev libboost-all-dev && \
  rm -rf /var/lib/apt/lists/*
WORKDIR /src
COPY . .
RUN cmake -S . -B build -DCMAKE_BUILD_TYPE=Release && \
    cmake --build build --parallel

# runtime
FROM ubuntu:22.04
RUN apt-get update && apt-get install -y \
  libssl3 libboost-system1.74.0 libboost-filesystem1.74.0 libboost-thread1.74.0 ca-certificates && \
  rm -rf /var/lib/apt/lists/*
WORKDIR /app
COPY --from=builder /src/build/qtc_node /usr/local/bin/qtc_node
EXPOSE 18444 18443
HEALTHCHECK --interval=30s --timeout=5s --retries=3 CMD qtc_node --version || exit 1
ENTRYPOINT ["qtc_node"]
